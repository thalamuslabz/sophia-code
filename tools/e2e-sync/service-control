#!/bin/bash
#
# E2E Sync Service Control Script
#
# Usage:
#   ./service-control status    # Check service status
#   ./service-control start     # Start the service
#   ./service-control stop      # Stop the service  
#   ./service-control restart   # Restart the service
#   ./service-control logs      # View recent logs
#   ./service-control unload    # Unload service completely
#

PLIST="$HOME/Library/LaunchAgents/com.thalamus.e2e-sync.plist"
LABEL="com.thalamus.e2e-sync"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

show_help() {
    echo "E2E Sync Service Control"
    echo ""
    echo "Usage: $0 <command>"
    echo ""
    echo "Commands:"
    echo "  status     Check if service is running"
    echo "  start      Start the service"
    echo "  stop       Stop the service"
    echo "  restart    Restart the service"
    echo "  logs       View recent logs"
    echo "  follow     Follow logs in real-time"
    echo "  unload     Unload service (disable auto-start)"
    echo "  load       Load service (enable auto-start)"
    echo ""
    echo "The service:"
    echo "  â€¢ Runs every 5 minutes"
    echo "  â€¢ Starts automatically on login"
    echo "  â€¢ Performs full e2e sync (repo â†’ obsidian â†’ Open WebUI)"
}

check_status() {
    if launchctl list | grep -q "$LABEL"; then
        echo -e "${GREEN}âœ… Service is loaded and running${NC}"
        PID=$(launchctl list | grep "$LABEL" | awk '{print $1}')
        echo "   PID: $PID"
        echo "   Plist: $PLIST"
        
        # Check if logs exist
        if [ -f "$HOME/logs/e2e-sync.log" ]; then
            LAST_RUN=$(tail -1 "$HOME/logs/e2e-sync.log" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}' || echo "unknown")
            echo "   Last log entry: $LAST_RUN"
        fi
    else
        echo -e "${RED}âŒ Service is not loaded${NC}"
        echo "   Run: $0 load"
    fi
}

start_service() {
    if launchctl list | grep -q "$LABEL"; then
        echo -e "${YELLOW}âš ï¸  Service is already running${NC}"
    else
        launchctl load "$PLIST"
        echo -e "${GREEN}âœ… Service loaded and started${NC}"
    fi
}

stop_service() {
    if launchctl list | grep -q "$LABEL"; then
        launchctl unload "$PLIST"
        echo -e "${GREEN}âœ… Service stopped${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Service is not running${NC}"
    fi
}

restart_service() {
    stop_service
    sleep 1
    start_service
    echo -e "${GREEN}âœ… Service restarted${NC}"
}

show_logs() {
    LOG_FILE="$HOME/logs/e2e-sync.log"
    if [ -f "$LOG_FILE" ]; then
        echo -e "${BLUE}ğŸ“‹ Last 50 lines of e2e-sync.log:${NC}"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        tail -50 "$LOG_FILE"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    else
        echo -e "${YELLOW}âš ï¸  Log file not found: $LOG_FILE${NC}"
    fi
}

follow_logs() {
    LOG_FILE="$HOME/logs/e2e-sync.log"
    if [ -f "$LOG_FILE" ]; then
        echo -e "${BLUE}ğŸ“‹ Following logs (Ctrl+C to exit):${NC}"
        tail -f "$LOG_FILE"
    else
        echo -e "${YELLOW}âš ï¸  Log file not found: $LOG_FILE${NC}"
    fi
}

unload_service() {
    stop_service
    echo -e "${GREEN}âœ… Service unloaded (will not auto-start on login)${NC}"
}

load_service() {
    launchctl load "$PLIST"
    echo -e "${GREEN}âœ… Service loaded (will auto-start on login)${NC}"
}

# Main
case "${1:-}" in
    status)
        check_status
        ;;
    start)
        start_service
        ;;
    stop)
        stop_service
        ;;
    restart)
        restart_service
        ;;
    logs)
        show_logs
        ;;
    follow)
        follow_logs
        ;;
    unload)
        unload_service
        ;;
    load)
        load_service
        ;;
    *)
        show_help
        ;;
esac
