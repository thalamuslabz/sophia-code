#!/bin/bash
#
# Intelligent RAG CLI Wrapper
# 
# Provides convenient commands for managing the Intelligent RAG system
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PYTHON_SCRIPT="$SCRIPT_DIR/intelligent_rag.py"
PID_FILE="$HOME/.intelligent_rag.pid"
LOG_FILE="$HOME/.intelligent_rag.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if Python is available
check_python() {
    if ! command -v python3 &> /dev/null; then
        log_error "python3 is required but not installed"
        exit 1
    fi
}

# Start the server
start_server() {
    local port=${1:-8765}
    local host=${2:-localhost}
    
    # Check if already running
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            log_warning "Server is already running (PID: $pid)"
            log_info "Access it at http://$host:$port"
            return
        fi
    fi
    
    log_info "Starting Intelligent RAG Server on $host:$port..."
    
    # Start server in background
    nohup python3 "$PYTHON_SCRIPT" server --host "$host" --port "$port" > "$LOG_FILE" 2>&1 &
    local server_pid=$!
    
    # Save PID
    echo $server_pid > "$PID_FILE"
    
    # Wait a moment and check if it's running
    sleep 2
    
    if ps -p "$server_pid" > /dev/null 2>&1; then
        log_success "Server started successfully (PID: $server_pid)"
        log_info "Access it at http://$host:$port"
        log_info "Logs: tail -f $LOG_FILE"
    else
        log_error "Server failed to start. Check logs: $LOG_FILE"
        rm -f "$PID_FILE"
        exit 1
    fi
}

# Stop the server
stop_server() {
    if [ ! -f "$PID_FILE" ]; then
        log_warning "No PID file found. Server may not be running."
        return
    fi
    
    local pid=$(cat "$PID_FILE")
    
    if ps -p "$pid" > /dev/null 2>&1; then
        log_info "Stopping server (PID: $pid)..."
        kill "$pid"
        
        # Wait for process to terminate
        local count=0
        while ps -p "$pid" > /dev/null 2>&1 && [ $count -lt 10 ]; do
            sleep 1
            ((count++))
        done
        
        if ps -p "$pid" > /dev/null 2>&1; then
            log_warning "Server did not stop gracefully. Force killing..."
            kill -9 "$pid" 2>/dev/null
        fi
        
        log_success "Server stopped"
    else
        log_warning "Server process not found (PID: $pid)"
    fi
    
    rm -f "$PID_FILE"
}

# Check server status
status() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            log_success "Server is running (PID: $pid)"
            log_info "Logs: tail -f $LOG_FILE"
            
            # Try to get health check
            if command -v curl &> /dev/null; then
                local health=$(curl -s http://localhost:8765/health 2>/dev/null)
                if [ -n "$health" ]; then
                    log_info "Health: $health"
                fi
            fi
        else
            log_warning "Server is not running (stale PID file)"
            rm -f "$PID_FILE"
        fi
    else
        log_info "Server is not running"
    fi
}

# View logs
logs() {
    if [ -f "$LOG_FILE" ]; then
        tail -f "$LOG_FILE"
    else
        log_warning "No log file found"
    fi
}

# Classify a query
classify() {
    local query="$1"
    if [ -z "$query" ]; then
        log_error "No query provided"
        echo "Usage: rag-cli classify 'your query here'"
        exit 1
    fi
    
    python3 "$PYTHON_SCRIPT" --classify "$query"
}

# Interactive mode
interactive() {
    python3 "$PYTHON_SCRIPT" --interactive
}

# Test with sample queries
test_queries() {
    log_info "Running test queries..."
    
    local queries=(
        "What's the API endpoint for user authentication?"
        "How do I configure the database connection?"
        "Review the complete authentication architecture"
        "Create a full architecture diagram package"
        "What is the function signature for createUser?"
        "How does Service A connect to Service B?"
        "Generate comprehensive documentation"
    )
    
    for query in "${queries[@]}"; do
        echo ""
        log_info "Testing: $query"
        python3 "$PYTHON_SCRIPT" --classify "$query"
        echo ""
        read -p "Press Enter to continue..."
    done
}

# Install as a service (macOS/Unix)
install_service() {
    log_info "Installing Intelligent RAG service..."
    
    # Create launchd plist for macOS
    if [[ "$OSTYPE" == "darwin"* ]]; then
        local plist_path="$HOME/Library/LaunchAgents/com.thalamus.intelligent-rag.plist"
        
        cat > "$plist_path" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.thalamus.intelligent-rag</string>
    <key>ProgramArguments</key>
    <array>
        <string>$(which python3)</string>
        <string>$PYTHON_SCRIPT</string>
        <string>server</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>$LOG_FILE</string>
    <key>StandardErrorPath</key>
    <string>$LOG_FILE</string>
</dict>
</plist>
EOF
        
        launchctl load "$plist_path" 2>/dev/null || true
        log_success "Service installed. It will start automatically on login."
        log_info "To start now: launchctl start com.thalamus.intelligent-rag"
        
    # Create systemd service for Linux
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        log_warning "Systemd service installation not implemented yet"
        log_info "Please manually create a systemd service"
    else
        log_warning "Unsupported OS for service installation"
    fi
}

# Show help
show_help() {
    cat << EOF
Intelligent RAG CLI

Usage: rag-cli [command] [options]

Commands:
    start [port] [host]   Start the RAG server (default port: 8765)
    stop                  Stop the RAG server
    status                Check server status
    logs                  View server logs
    classify "query"      Classify a specific query
    interactive           Run interactive classification mode
    test                  Run test queries
    install-service       Install as a system service
    help                  Show this help message

Environment Variables:
    INTELLIGENT_RAG_URL   URL of the classifier service
                          (default: http://localhost:8765)

Examples:
    rag-cli start                    # Start server on default port
    rag-cli start 8080 0.0.0.0      # Start on port 8080, all interfaces
    rag-cli classify "What's the auth endpoint?"
    rag-cli interactive

EOF
}

# Main command dispatch
check_python

case "${1:-help}" in
    start)
        start_server "${2:-8765}" "${3:-localhost}"
        ;;
    stop)
        stop_server
        ;;
    status)
        status
        ;;
    logs)
        logs
        ;;
    classify)
        classify "$2"
        ;;
    interactive|i)
        interactive
        ;;
    test)
        test_queries
        ;;
    install-service)
        install_service
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        log_error "Unknown command: $1"
        show_help
        exit 1
        ;;
esac
