{
  "name": "Vault â†’ Qdrant Sync",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{ "field": "hours", "expression": "6" }]
        },
        "timezone": "America/New_York"
      },
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [150, 300]
    },
    {
      "parameters": {},
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [150, 450]
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\nconst path = require('path');\n\nconst vaultPath = process.env.OBSIDIAN_VAULT_PATH || '/obsidian-vault';\n\nfunction scanDirectory(dir, baseDir) {\n  const files = [];\n  const items = fs.readdirSync(dir);\n  \n  for (const item of items) {\n    const fullPath = path.join(dir, item);\n    const stat = fs.statSync(fullPath);\n    \n    if (stat.isDirectory() && !item.startsWith('.') && item !== '_templates') {\n      files.push(...scanDirectory(fullPath, baseDir));\n    } else if (stat.isFile() && item.endsWith('.md')) {\n      const content = fs.readFileSync(fullPath, 'utf8');\n      const relativePath = path.relative(baseDir, fullPath);\n      \n      let frontmatter = {};\n      let bodyContent = content;\n      const frontmatterMatch = content.match(/^---\\n([\\s\\S]*?)\\n---\\n(.*)$/);\n      if (frontmatterMatch) {\n        bodyContent = frontmatterMatch[2];\n        const lines = frontmatterMatch[1].split('\\n');\n        for (const line of lines) {\n          const parts = line.split(':');\n          if (parts.length >= 2) {\n            frontmatter[parts[0].trim()] = parts.slice(1).join(':').trim();\n          }\n        }\n      }\n      \n      files.push({\n        path: relativePath,\n        fullPath,\n        content: bodyContent.trim(),\n        frontmatter,\n        modified: stat.mtime.toISOString()\n      });\n    }\n  }\n  \n  return files;\n}\n\nconst files = scanDirectory(vaultPath, vaultPath);\nreturn files.map(f => ({ json: f }));"
      },
      "name": "Scan Vault Files",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [350, 300]
    },
    {
      "parameters": {
        "jsCode": "const CHUNK_SIZE = 500;\nconst CHUNK_OVERLAP = 100;\n\nconst content = $json.content;\nconst chunks = [];\n\nif (content.length <= CHUNK_SIZE) {\n  chunks.push(content);\n} else {\n  let i = 0;\n  while (i < content.length) {\n    chunks.push(content.substring(i, i + CHUNK_SIZE));\n    i += CHUNK_SIZE - CHUNK_OVERLAP;\n  }\n}\n\nreturn chunks.map((chunk, index) => ({\n  json: {\n    path: $json.path,\n    fullPath: $json.fullPath,\n    frontmatter: $json.frontmatter,\n    modified: $json.modified,\n    chunk,\n    chunkIndex: index,\n    totalChunks: chunks.length,\n    chunkId: `${$json.path}-${index}`\n  }\n}));"
      },
      "name": "Chunk Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [550, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:11434/api/embeddings",
        "sendBody": true,
        "contentType": "json",
        "body": { "model": "all-minilm", "prompt": "={{ $json.chunk }}" }
      },
      "name": "Generate Embedding",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [750, 300]
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "http://qdrant:6333/collections/obsidian-vault/points",
        "sendBody": true,
        "contentType": "json",
        "body": {
          "points": [\n            {\n              "id": "={{ $('Chunk Content').item.json.chunkId }}",\n              "vector": "={{ $json.embedding }}",\n              "payload": {\n                "content": "={{ $('Chunk Content').item.json.chunk }}",\n                "source": "={{ $('Chunk Content').item.json.path }}",\n                "project": "={{ $('Chunk Content').item.json.frontmatter.project || 'unknown' }}",\n                "type": "={{ $('Chunk Content').item.json.frontmatter.type || 'note' }}",\n                "modified": "={{ $('Chunk Content').item.json.modified }}",\n                "chunk_index": "={{ $('Chunk Content').item.json.chunkIndex }}"\n              }\n            }\n          ]\n        }\n      },
      "name": "Store in Qdrant",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [950, 300]
    },
    {
      "parameters": {},
      "name": "Success",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1150, 300]
    }
  ],
  "connections": {
    "Schedule Trigger": { "main": [[{"node": "Scan Vault Files", "type": "main", "index": 0}]] },
    "Manual Trigger": { "main": [[{"node": "Scan Vault Files", "type": "main", "index": 0}]] },
    "Scan Vault Files": { "main": [[{"node": "Chunk Content", "type": "main", "index": 0}]] },
    "Chunk Content": { "main": [[{"node": "Generate Embedding", "type": "main", "index": 0}]] },
    "Generate Embedding": { "main": [[{"node": "Store in Qdrant", "type": "main", "index": 0}]] },
    "Store in Qdrant": { "main": [[{"node": "Success", "type": "main", "index": 0}]] }
  },
  "settings": { "executionOrder": "v1" },
  "tags": ["qdrant", "obsidian", "embeddings", "semantic-search"]
}
